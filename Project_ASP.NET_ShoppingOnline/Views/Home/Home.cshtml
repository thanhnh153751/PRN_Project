
@{
    ViewData["Title"] = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using Project_ASP.NET_ShoppingOnline.Models;
@section styles{
    <style>
        .pagination {
            display: inline-block;
        }

            .pagination a {
                color: black;
                font-size: 22px;
                float: left;
                padding: 8px 16px;
                text-decoration: none;
            }

                .pagination a.active {
                    background-color: #ee3e0f;
                    color: black;
                }

                .pagination a:hover:not(.active) {
                    background-color: #ee3e0f;
                }
    </style>
}

<div class="row">
    <div class="col-md-12">
        <div class="title">
            <h2> Categories</h2>
            <input id="curentId" type="hidden" value="0" />
            <ul class="categiri">

                <li id="0" class="cateid" onclick="loadProduct()"><a href="/Home/home2/0">ALL</a></li>
                @foreach (Category category in ViewBag.Allcategories)
                {
                    <li id="@category.CategoryId" class="cateid"><a href="/Home/home2/@category.CategoryId">@category.CategoryName</a></li>
                }
            </ul>

            @*<c:set var="cid" value="${requestScope.cid}" />

                    <form id="f" action="list">
                        <ul class="categiri" onchange="document.getElementById('f').submit()">
                            <li <c:if test="${cid==0}">class="active"</c:if> ><a href="home?cid=0">ALL</a></li>
                            <c:forEach items="${requestScope.category}" var="c">

                                <li <c:if test="${c.categoryID==cid}">class="active"</c:if>   ><a href="home?cid=${c.categoryID}">${c.categoryName}</a></li>

                            </c:forEach>


                        </ul>
                     </form>*@

        </div>
    </div>
</div>

<div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
    <ol class="carousel-indicators">
        <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
        <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
        <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img class="d-block w-100" src="~/images/baner_1.jpg" alt="First slide">
        </div>
        <div class="carousel-item">
            <img class="d-block w-100" src="~/images/baner_2.jpg" alt="Second slide">
        </div>
        <div class="carousel-item">
            <img class="d-block w-100" src="~/images/baner_3.jpg" alt="Third slide">
        </div>
    </div>
    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
</div>

<!-- Categories -->
<div class="Categories">
    <div class="container">





        <!-- news shoes -->
        <div id="shoes" class="shoes-bg">
            <h3>New shoes</h3>
            <div class="row">
                @foreach (Product product in ViewBag.NewsProducts)
                {

                    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12 ">
                        <div class="shoes-box">

                            <i><img src="~/@product.Image" /></i>

                            <p class="nolmal">@product.ProductName</p>
                            <h4>Price: <span class="nolmal monney" style="color: red">@product.UnitPrice</span>đ <br /><span style="font-size: 70%;">kho:@product.UnitsInStock</span></h4>
                        </div>
                        <div style="display: flex;">
                            <a class="buynow" onclick="buynow('${p.productID}')">Buy now</a>
                            <a class="buynow" onclick="buypn('${p.productID}')">Add to cart</a>

                        </div>

                    </div>

                }
            </div>

            @*<script type="text/javascript">
                    function buypn(id) {
                        console.log('????????????????');
                        document.fpn.action = "buy?id=" + id + "&num=" + 1;
                        document.fpn.submit();

                    }
                    function buynow(id) {
                        document.fpn.action = "buy?id=" + id + "&num=" + 1 + "&now=1";
                        document.fpn.submit();
                    }
                </script>*@
        </div>













        <!-- all shoes -->
        <div id="shoes" class="shoes-bg">
            <h3>
            </h3>
            <div class="row" id="productHome">

            </div>

        </div>
        <!-- end all shoes -->
        <!--phần phân trang-->
        <input id="page" type="hidden" value="1" />

        <div class="pagination" id="paginationP">

            @*@if (ViewBag.Page > 1)
                {
                    <a href="@Url.Action("listProduct","Product", new {id = ViewBag.CurOrder, page = ViewBag.Page - 1 })" class="btn btn-default"> &laquo; Prev </a>
                }

                @for (var i = 1; i <= ViewBag.MaxPage + 1; i++)
                {
                    <a class="@(ViewBag.Page == i?"active":"")" href="@Url.Action("listProduct","Product", new {id = ViewBag.CurOrder, page = i})">@i</a>
                }

                @if (ViewBag.Page < ViewBag.MaxPage + 1)
                {
                    <a href="@Url.Action("listProduct","Product", new {id = ViewBag.CurOrder,page = ViewBag.Page + 1 })" class="btn btn-default">Next &raquo;</a>
                }*@

        </div>

    </div>

</div>



@section script{
    <script type="text/javascript">
        window.onbeforeunload = function () {
            let curent = $("input[id='curentId']").attr('value');
            if (curent == null) curent = 0;
            localStorage.setItem("curId", $('#curentId').val());


            localStorage.setItem("page", $("input[id='page']").attr('value'));
        }

        $(document).ready(function () {//load ra các product theo category first truy cập
            //dùng curent index

            //let curent = $("input[id='curentId']").attr('value');
            let curId = localStorage.getItem('curId');
            $("input[id='curentId']").val("" + curId + "");


            let pageN = localStorage.getItem('page');
            $("input[id='page']").val("" + pageN + "");

            //khi f5 vẫn giữ lại các tùy chọn
            loadProduct(curId);
            Array.from(document.getElementsByClassName("cateid")).forEach(
                function (element, index, array) {
                    if (element.id == curId) {
                        element.classList.add("active");
                    } else {
                        element.classList.remove("active");
                    }

                }
            );





        });



        function loadProduct(cid) {
            let npage = $("input[id='page']").attr('value');

            $.ajax({
                url: "/Product/GetProductByCategoryId",
                type: "GET",

                data: {
                    id: cid,
                    page: npage
                },
                dataType: "JSON",
                contentType: 'application/json;charset=utf-8',
                success: function (data) {

                    if (data.code == 666) {
                        $('#productHome').empty();
                        $.each(data.listProduct, function (k, v) {

                            let tr = '<div class="col-xl-3 col-lg-3 col-md-6 col-sm-12 margintop">';
                            tr += '<div class="shoes-box">';
                            tr += '<i><img src="' + v.image + '" /></i>';
                            tr += '<p><span class="nolmal">' + v.productName + '</span></p>';
                            tr += '<h4>Price: <span class="nolmal monney" style="color: red">' + v.unitPrice + '</span>đ <br/><span style="font-size: 70%;">kho:' + v.unitsInStock + '</span></h4>';
                            tr += '</div>';
                            tr += '<div style="display: flex;">';
                            tr += '<a class="buynow" onclick="buynow()">Buy now</a>';
                            tr += '<a class="buynow" onclick="buypn()" >Add to cart</a>';
                            tr += '</div> ';

                            $('#productHome').append(tr);

                        });

                        $('#paginationP').empty();
                        let pa = '';

                        if (data.page > 1) {

                            pa += '<a class="btn btn-default "> &laquo; Prev </a>';
                        }

                        for (var i = 1; i <= data.maxpage + 1; i++) {

                            pa += '<a  class=" ' + ((npage == i) ? "active" : "") + ' " >' + i + '</a>';
                        }
                        if (data.page < data.maxpage + 1) {
                            pa += '<a class="btn btn-default ">Next &raquo;</a>';
                        }
                        $('#paginationP').append(pa);

                        //lấy số page và cid
                        $('#paginationP a').click(function () {
                            let page = $(this).html();
                            if (page.toString().includes('Next')) {
                                page = parseInt($("input[id='page']").attr('value')) + 1;

                            }
                            if (page.toString().includes('Prev')) {
                                page = parseInt($("input[id='page']").attr('value')) - 1;

                            }
                            $("input[id='page']").val("" + page + "");
                            let curent = $("input[id='curentId']").attr('value');

                            loadProduct(curent);
                        });



                    } else {

                        alert(data.msg);
                    }

                },
                error: function (error) {

                    alert('error');
                }
            });
        }






        $('li.cateid').click(function () {//load ra các product theo category
            let id = $(this).attr('id');
            $("input[id='page']").val("" + 1 + "");
            $("input[id='curentId']").val("" + id + "");

            loadProduct(id);
            Array.from(document.getElementsByClassName("cateid")).forEach(
                function (element, index, array) {
                    if (element.id == id) {
                        element.classList.add("active");
                    } else {
                        element.classList.remove("active");
                    }

                }
            );




        });




    </script>
}




